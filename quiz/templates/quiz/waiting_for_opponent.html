{% extends 'quiz/base.html' %}

{% block content %}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg">
                <div class="card-header bg-warning text-dark">
                    <h2 class="mb-0"><i class="bi bi-hourglass-split me-2"></i>Finding Your Opponent...</h2>
                </div>
                <div class="card-body p-5 text-center">
                    <div class="mb-4">
                        <h4>{{ quiz.title }}</h4>
                        <p class="text-muted">{{ quiz.topic }} - <span class="badge bg-info">{{ quiz.difficulty }}</span></p>
                    </div>

                    <div class="spinner-border text-warning mb-4" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>

                    <h5 class="mb-3">Searching for an opponent...</h5>
                    <p class="text-muted mb-4">You'll be matched with another player soon. Please wait!</p>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Match Details:</strong>
                        <ul class="mb-0 mt-2">
                            <li>{{ quiz.questions.count }} Questions</li>
                            <li>Best player wins!</li>
                            <li>Results will be added to your leaderboard</li>
                        </ul>
                    </div>

                    <hr class="my-4">

                    <p class="text-muted small mb-3">Match ID: <code>{{ match.id }}</code></p>

                    <a href="{% url 'home' %}" class="btn btn-secondary">
                        <i class="bi bi-x-circle me-2"></i>Cancel
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
const apiFindUrl = "{% url 'api_find_match' quiz.id %}";
let matchId = "{{ match.id }}";
let pollAttempts = 0;

async function attemptFindMatch() {
    pollAttempts++;
    try {
        console.log(`[AJAX #${pollAttempts}] Calling ${apiFindUrl}...`);
        const resp = await fetch(apiFindUrl, { credentials: 'same-origin' });
        if (!resp.ok) {
            console.error('[AJAX] HTTP error:', resp.status);
            return;
        }
        const data = await resp.json();
        console.log(`[AJAX #${pollAttempts}] Response:`, data);
        
        if (data.status === 'matched') {
            console.log('[AJAX] ✓✓✓ MATCHED! Redirecting to lobby...');
            clearInterval(pollId);
            window.location.href = data.match_lobby_url;
        } else if (data.status === 'waiting') {
            matchId = data.match_id;
            document.getElementById('match-id').textContent = matchId;
            console.log(`[AJAX #${pollAttempts}] Still waiting for opponent... (match_id=${matchId})`);
        }
    } catch (e) {
        console.error(`[AJAX #${pollAttempts}] Error:`, e);
    }
}

// Attempt immediately on page load
console.log('[Page Init] Starting auto-match polling...');
attemptFindMatch();

// Then poll every 800ms
const pollId = setInterval(attemptFindMatch, 800);

// Safeguard: stop polling after 5 minutes (300 attempts at 800ms)
setTimeout(() => {
    clearInterval(pollId);
    console.warn('[AJAX] Polling timeout - 5 minutes reached');
}, 300000);

</script>
{% endblock %}

{% endblock %}
